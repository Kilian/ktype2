<html>
<head>
  <script type="text/javascript" src="akihabara/gbox.js"></script>
  <script type="text/javascript" src="akihabara/iphopad.js"></script>
  <script type="text/javascript" src="akihabara/trigo.js"></script>
  <script type="text/javascript" src="akihabara/toys.js"></script>
  <script type="text/javascript" src="akihabara/help.js"></script>
  <script type="text/javascript" src="akihabara/tool.js"></script>
  <script type="text/javascript" src="akihabara/gamecycle.js"></script>
  <style>body { -webkit-user-select:none; margin:0px}</style>
  <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" />
</head>
<body>
</body>

  <script>
    var maingame,
        scroller,
        frameCount = 0,
        score= 0,
        lives= 3;

    window.addEventListener('load', loadResources, false);

    function setScore(value) {
      score += value;
      maingame.hud.setValue("score","value",score);
    }

    function setLevel(value) {
      level += value;
      maingame.hud.setValue("level","value",level);
    }

    function setLife(value) {
      lives += value;
      if (lives > 3)  {
        lives = 3;
      }
      if (lives < 1) {
        maingame.hud.setValue("lives","value",lives);
        maingame.endlevelIntroAnimation = function() {return true;};
        maingame.gameEndingIntroAnimation = function() {return true;};
        maingame.playerDied();
        maingame.gameIsCompleted(); // dead
      } else {
        maingame.hud.setValue("lives","value",lives);
      }
    }

    function loadResources() {
      help.akihabaraInit({
        title: 'kType',
        width: 640,
        height: 480,
        zoom: 1
      });

      gbox.addImage('font', 'font.png');
      gbox.addFont({ id: 'small', image: 'font', firstletter: ' ', tileh: 8, tilew: 8, tilerow: 255, gapx: 0, gapy: 0 });

      gbox.addImage('playerSprite', 'player.png');
      gbox.addTiles({
        id:      'playerTiles',
        image:   'playerSprite',
        tileh:   24,
        tilew:   38,
        tilerow: 6,
        gapx:    0,
        gapy:    0,
      });

      gbox.addImage('bulletImg', 'playerSprite.png');
      gbox.addTiles({
        id:      'bulletTile',
        image:   'bulletImg',
        tileh:   16,
        tilew:   16,
        tilerow: 1,
        gapx:    0,
        gapy:    0,
      });

      gbox.addImage('enemySprite', 'enemy.png');
      gbox.addTiles({
        id:      'enemyTiles',
        image:   'enemySprite',
        tileh:   24,
        tilew:   38,
        tilerow: 6,
        gapx:    0,
        gapy:    0
      });

      gbox.addImage('logo', 'logo.png');
      gbox.addImage('backgroundImg', 'background.png');
      gbox.addImage('movingstars', 'movingstars.png');

      gbox.setCallback(main);
      gbox.loadAll();
    }

    function main() {
      gbox.setGroups(['background', 'player', 'enemy', 'playerbullets', 'enemybullets', 'game']);
      maingame = gamecycle.createMaingame('game', 'game');

      maingame.gameMenu = function () {return true;}; // no menu
      maingame.gameIntroAnimation = function() {return true;}; //no game intro animation

      maingame.newLife = function () { //player is reborn
        setLife(4);
      };

      maingame.gameTitleIntroAnimation=function(reset) { //simple title animation
        if (reset) {
          toys.resetToy(this, 'rising');
        }

        gbox.blitFade(gbox.getBufferContext(),{ alpha: 1 });

        toys.logos.linear(this, 'rising', {
          image: 'logo',
          sx:    gbox.getScreenW()/2-gbox.getImage('logo').width/2,
          sy:    gbox.getScreenH(),
          x:     gbox.getScreenW()/2-gbox.getImage('logo').width/2,
          y:     20,
          speed: 1
        });
      };

      maingame.changeLevel=function(level) {
        // The first time the "changeLevel" is called, level is NULL. Our first stage is "1", so...
        if (level==null) {
          level=1;
        }

        maingame.level=level; // "maingame" is handy enough to store some game data.
        maingame.hud.setValue("level","value",level);

        maingame.enemiesToKill = level*15;
        if (level < 8) {
          maingame.enemiesSpeed = parseInt(5 + level, "10");
        } else if (level > 15) {
          maingame.enemiesSpeed = parseInt(12, "10");
        } else {
          maingame.enemiesSpeed = parseInt(5 + level*0.5, "10");
        }

        this.newLife();
        setLife(4);
      };

      maingame.newLife = function(up) {
      }

      maingame.initializeGame = function() {
        maingame.hud.setWidget("scorename",{widget:"label",font:"small",value:"score:",dx:550,dy:5,clear:true});
        maingame.hud.setWidget("score",{widget:"label",font:"small",value:0,dx:600,dy:5,clear:true});

        maingame.hud.setWidget("levelname",{widget:"label",font:"small",value:"level:",dx:550,dy:20,clear:true});
        maingame.hud.setWidget("level",{widget:"label",font:"small",value:1,dx:600,dy:20,clear:true});

        maingame.hud.setWidget("lives",{widget:"symbols",minvalue:0,value:3,maxshown:3,tileset:"playerTiles",tiles:[0],dx:10,dy:5,gapx:30,gapy:0}); // The number of ships remaining

        addBackground();
        addPlayer();
      }

      gbox.go();
    }

    function addBackground() {
      gbox.addObject({
        id: 'backgroundid',
        group: 'background',
        initialize: function () {
          scroller = toys.shmup.generateScroller("background", "scroller", {
            maxwidth: 1280,
            stage:  [{image:"movingstars"},{image:"movingstars"},{image:"movingstars"},{image:"movingstars"}], // why 4?
            speed: 1,
          });
          this.timeout = 1;
          this.shipcounter = 1;
        },
        first: function () { //before drawing
          // Increment the global frame counter.
          frameCount++;
          this.script();
        },
        blit: function () { //drawing
          gbox.blitFade(gbox.getBufferContext(),{}); //clear screen
          gbox.blitAll(gbox.getBufferContext(), gbox.getImage('backgroundImg'), { dx: 0, dy: 0, alpha: 1});
        },
        script: function(x) {

          //works but not like it should
          if(scroller.x == 640) {
            scroller.x = 0
          }
          scroller.x += 5;

          //check if next level
          if (maingame.enemiesToKill < 1) {
            maingame.changeLevel(maingame.level+1);
          }


          //randomly generate enemies
          this.timeout -= 1;
          if (this.timeout < 1 && Math.random() < 0.1*maingame.level) {
            this.timeout = 40 - maingame.level*1.5;
            addEnemy(640, help.random(35, 400), this.shipcounter++);
          }
        }
      });
    }

    function addPlayer() {
      gbox.addObject({
        id: 'playerid',
        group: 'player',
        tileset: 'playerTiles',
        speed: 4,

        initialize: function () {
          toys.shmup.initialize(this, {
            bounds:{x:0,y:35,w:gbox.getScreenW(),h:gbox.getScreenH()-58},
          });
          this.x = 30;
          this.y= 240;
          this.timeout = 1;

          this.anim = {speed: 1, frames: [0,1,2,3,4,5]};
        },
        first: function () { //before drawing

          if (!this.killed&&!maingame.gameIsHold()) {
            toys.shmup.controlKeys(this, { left: 'left', right: 'right', up: 'up', down: 'down' });
            toys.shmup.handleAccellerations(this);
            toys.shmup.applyForces(this);
            toys.shmup.keepInBounds(this);

            //animation
            if (frameCount%this.anim.speed == 0) {
              this.frame = help.decideFrame(frameCount, this.anim);
            }

            this.timeout--;
            if (gbox.keyIsHit("a") && this.timeout < 1) {
              this.fireBullet();
            }
          }

        },
        blit: function () { //drawing
          if (!this.killed) {
            gbox.blitTile(gbox.getBufferContext(), {
              tileset: this.tileset,
              tile: this.frame,
              dx: this.x,
              dy: this.y,
              fliph:  this.fliph,
              flixv: this.flipv,
              camera: this.camera,
              alpha: 1
            });
          }
        },
        //helper functions
        kill:function() {
          if (!this.killed) { // If we're alive...
            this.killed=true;
            setLife(-1);
          }
        },
        fireBullet:function() {
          this.timeout = 5;
          toys.shmup.fireBullet("playerbullets",null, {
            collidegroup:"enemy",
            from:this,
            colh: gbox.getTiles('bulletTile').tileh,
            tileset:"bulletTile",
            frames:{speed:1,frames:[0]},
            accx:8,accy:0});
        },
        hitByBullet: function(by) {
          setLife(-1);
          this.x = 30;
          this.y= 240;
          this.timeout = 1;
          //gbox.trashGroup("enemybullets"); //this causes an error?
          gbox.trashGroup("enemy");
          gbox.purgeGarbage();
        }
      });
    }

    function addEnemy(xx, yy, id) {
      gbox.addObject({
        id: 'enemy_id' + id,
        group: 'enemy',
        tileset: 'enemyTiles',
        colh: gbox.getTiles('enemyTiles').tileh,
        speed: 2,
        health: 1,
        initialize: function () {
          toys.shmup.initialize(this, {});

          this.x = xx;
          this.y = yy;

          this.timeout = 1;
          this.anim = {speed: 1, frames: [0,1,2,3,4,5]};
        },
        first: function() {
          //move enemy
          this.x = this.x - maingame.enemiesSpeed;

          if(this.x < 0) {
            this.kill();
          }
          //animation

          if (frameCount%this.anim.speed == 0) {
            this.frame = help.decideFrame(frameCount, this.anim);
          }

          //TODO some random shooting here
          this.timeout--;
          if (this.timeout < 1 && Math.random() < 0.1) {
            this.fireBullet();
            this.timeout = 20;
          }
        },
        blit: function() {
          gbox.blitTile(gbox.getBufferContext(), {
            tileset: this.tileset,
            tile: this.frame,
            dx: this.x,
            dy: this.y,
            fliph:  this.fliph,
            flixv: this.flipv,
            camera: this.camera,
            alpha: 1
          });
        },
        //helper functions
        fireBullet:function() {
          this.timeout = 5;
          toys.shmup.fireBullet("enemybullets",null, {
            collidegroup:"player",
            from:this,
            colh: gbox.getTiles('bulletTile').tileh,
            tileset:"bulletTile",
            frames:{speed:1,frames:[0]},
            accx:parseInt(maingame.enemiesSpeed*-1.5, 10),
            accy:0,
          });
        },
        kill: function() {
          gbox.trashObject(this);
          gbox.purgeGarbage();
        },
        hitByBullet: function(by) {
          setScore(10);
          maingame.enemiesToKill -= 1;
          gbox.trashObject(this);
          gbox.purgeGarbage();
        }
      });
    }

  </script>

</html>

