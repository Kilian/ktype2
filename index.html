<html>
<head>
  <script type="text/javascript" src="akihabara/gbox.js"></script>
  <script type="text/javascript" src="akihabara/iphopad.js"></script>
  <script type="text/javascript" src="akihabara/trigo.js"></script>
  <script type="text/javascript" src="akihabara/toys.js"></script>
  <script type="text/javascript" src="akihabara/help.js"></script>
  <script type="text/javascript" src="akihabara/tool.js"></script>
  <script type="text/javascript" src="akihabara/gamecycle.js"></script>
  <style>body { -webkit-user-select:none; margin:0px}</style>
  <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" />
</head>
<body>
</body>

  <script>
    var maingame,
        scroller,
        frameCount = 0,
        score= 0,
        lives= 3;

    window.addEventListener('load', loadResources, false);

    function setScore(value) {
      score += value;
      maingame.hud.setValue("score","value",score);
    }

    function setLevel(value) {
      level += value;
      maingame.hud.setValue("level","value",level);
    }

    function setLife(value) {
      lives += value;
      if (lives > 3)  {
        lives = 3;
      }
      if (lives < 1) {
        maingame.gameIsCompleted(); // dead
      } else {
        maingame.hud.setValue("lives","value",lives);
      }
    }

    function loadResources() {
      help.akihabaraInit({
        title: 'kType',
        width: 640,
        height: 480,
        zoom: 1
      });

      gbox.addImage('font', 'font.png');
      gbox.addFont({ id: 'small', image: 'font', firstletter: ' ', tileh: 8, tilew: 8, tilerow: 255, gapx: 0, gapy: 0 });

      gbox.addImage('playerSprite', 'player.png');
      gbox.addTiles({
        id:      'playerTiles',
        image:   'playerSprite',
        tileh:   24,
        tilew:   38,
        tilerow: 6,
        gapx:    0,
        gapy:    0,
      });

      gbox.addImage('bulletImg', 'playerSprite.png');
      gbox.addTiles({
        id:      'bulletTile',
        image:   'bulletImg',
        tileh:   16,
        tilew:   16,
        tilerow: 1,
        gapx:    0,
        gapy:    0,
      });

      gbox.addImage('enemySprite', 'enemy.png');
      gbox.addTiles({
        id:      'enemyTiles',
        image:   'enemySprite',
        tileh:   24,
        tilew:   38,
        tilerow: 6,
        gapx:    0,
        gapy:    0
      });

      gbox.addImage('logo', 'logo.png');
      gbox.addImage('backgroundImg', 'background.png');
      gbox.addImage('movingstars', 'movingstars.png');

      gbox.setCallback(main);
      gbox.loadAll();
    }

    function main() {
      gbox.setGroups(['background', 'player', 'enemy', 'playerbullets', 'enemybullets', 'game']);
      maingame = gamecycle.createMaingame('game', 'game');

      maingame.gameMenu = function () {return true;}; // no menu
      maingame.gameIntroAnimation = function() {return true;}; //no game intro animation

      maingame.newLife = function () { //player is reborn
        setLife(4);
      };

      maingame.gameTitleIntroAnimation=function(reset) { //simple title animation
        if (reset) {
          toys.resetToy(this, 'rising');
        }

        gbox.blitFade(gbox.getBufferContext(),{ alpha: 1 });

        toys.logos.linear(this, 'rising', {
          image: 'logo',
          sx:    gbox.getScreenW()/2-gbox.getImage('logo').width/2,
          sy:    gbox.getScreenH(),
          x:     gbox.getScreenW()/2-gbox.getImage('logo').width/2,
          y:     20,
          speed: 1
        });
      };

      maingame.changeLevel=function(level) {
        // The first time the "changeLevel" is called, level is NULL. Our first stage is "1", so...
        if (level==null) {
          level=1;
        }

        maingame.level=level; // "maingame" is handy enough to store some game data.
        maingame.hud.setValue("level","value",level);

        maingame.enemiesToKill = level*15
        if (level < 8) {
          maingame.enemiesSpeed = parseInt(5 + level, "10");
        } else if (level > 15) {
          maingame.enemiesSpeed = parseInt(12, "10");
        } else {
          maingame.enemiesSpeed = parseInt(5 + level*0.5, "10");
        }

        this.newLife();

      };

      maingame.newLife = function(up) {
      }

      maingame.initializeGame = function() {
        maingame.hud.setWidget("scorename",{widget:"label",font:"small",value:"score:",dx:550,dy:5,clear:true});
        maingame.hud.setWidget("score",{widget:"label",font:"small",value:0,dx:600,dy:5,clear:true});

        maingame.hud.setWidget("levelname",{widget:"label",font:"small",value:"level:",dx:550,dy:20,clear:true});
        maingame.hud.setWidget("level",{widget:"label",font:"small",value:1,dx:600,dy:20,clear:true});

        maingame.hud.setWidget("lives",{widget:"symbols",minvalue:0,value:3,maxshown:3,tileset:"playerTiles",tiles:[0],dx:10,dy:5,gapx:30,gapy:0}); // The number of ships remaining

        addBackground();
		  	addPlayer();
      }

      maingame.addEnemy = function (data) {
        gbox.addObject({
				  enemyid:data.id,
  				id:"enemy"+data.id,
  				group:"enemies",
  				tileset:"enemyTiles",
				  initialize:function() {
					  toys.shmup.initialize(this,{
  			      x:data.x,
					    y:data.y
					  });

					  this.anim = {speed: 1, frames: [0,1,2,3,4,5]};
				  },
				  first: function () {

				    //animation
            if (frameCount%this.anim.speed == 0) {
              this.frame = help.decideFrame(frameCount, this.anim);
            }

            //if enemy hits player, kill player and ship
            var player=gbox.getObject("player","playerid");
						if (gbox.collides(this,player,3)) {
  						player.kill();
  						this.kill(false);
						}
				  },
				  blit: function () {
					  gbox.blitTile(gbox.getBufferContext(),{tileset:this.tileset,tile:this.frame,dx:this.x,dy:this.y,fliph:this.fliph,flipv:this.flipv,camera:this.camera,alpha:1});
				  },
				  kill: function(points) {
            //if player scored, set the score and remove single enemy. Else, remove all enemies
				    if(points) {
				      setScore(100);
              gbox.trashObject(this);
				    } else {
				      gbox.trashGroup("enemybullets");
				      gbox.trashGroup("enemies");
				    }
            gbox.purgeGarbage();
				  }
        });
      }

      gbox.go();
    }

    function addBackground() {
      gbox.addObject({
        id: 'backgroundid',
        group: 'background',
        initialize: function () {
          scroller = toys.shmup.generateScroller("background", "scroller", {
            maxwidth: 1280,
            stage:  [{image:"movingstars"},{image:"movingstars"},{image:"movingstars"},{image:"movingstars"}], // why 4?
            speed: 1,
          });

        },
        first: function () { //before drawing
          // Increment the global frame counter.
          frameCount++;
          this.script();
        },
        blit: function () { //drawing
          gbox.blitFade(gbox.getBufferContext(),{}); //clear screen
          gbox.blitAll(gbox.getBufferContext(), gbox.getImage('backgroundImg'), { dx: 0, dy: 0, alpha: 1});
        },
        script: function(x) { //works but not like it should
          if(scroller.x == 640) {
            scroller.x = 0
          }
          scroller.x += 5;

        }
      });
    }

    function addPlayer() {
      gbox.addObject({
        id: 'playerid',
        group: 'player',
        tileset: 'playerTiles',


        initialize: function () {
          toys.shmup.initialize(this, {
            bounds:{x:0,y:35,w:gbox.getScreenW(),h:gbox.getScreenH()-58},
          });
          this.x = 30;
          this.y= 240;

          this.anim = {speed: 1, frames: [0,1,2,3,4,5]};
        },
        first: function () { //before drawing

          if (!this.killed&&!maingame.gameIsHold()) {
            toys.shmup.controlKeys(this, { left: 'left', right: 'right', up: 'up', down: 'down' });
            toys.shmup.handleAccellerations(this);
            toys.shmup.applyForces(this);
            toys.shmup.keepInBounds(this);

            //animation
            if (frameCount%this.anim.speed == 0) {
              this.frame = help.decideFrame(frameCount, this.anim);
            }

            if (gbox.keyIsHit("a")) {
              this.fireBullet();
            }
          }

        },
        blit: function () { //drawing
          if (!this.killed) {
            gbox.blitTile(gbox.getBufferContext(), {
              tileset: this.tileset,
              tile: this.frame,
              dx: this.x,
              dy: this.y,
              fliph:  this.fliph,
              flixv: this.flipv,
              camera: this.camera,
              alpha: 1
            });
          }
        },
        //helper functions
        kill:function() {
					if (!this.killed) { // If we're alive...
						this.killed=true;
						setLife(-1);

            //move player back to begin position
            this.x = 30;
            this.y= 240;
					}
				},
        fireBullet:function() {
          toys.shmup.fireBullet("playerbullets",null, {
            collidegroup:"enemies",
            from:this,
            tileset:"bulletTile",
            accx:8,accy:0});
        },
        hitByBullet: function(by) {
          toys.shmup.hitByBullet(this,by);
        }
      });
    }
  </script>

</html>

